#!/bin/sh
set -eu

cd -P -- "$(dirname -- "$0")"

echo ">>> Starting Postgres..."
pg_ctl -D "$PGDATA" -o "-c listen_addresses='*'" -w start

echo ">>> Waiting for Postgres to accept connections..."
until pg_isready -U postgres; do
  sleep 2
done

echo ">>> Ensuring database exists..."
createdb -U postgres scada_repo || true

echo ">>> Running migrations..."
./bin/peredacha eval "Peredacha.Release.migrate"

echo ">>> Starting Phoenix app..."
PHX_SERVER=true exec ./peredacha start